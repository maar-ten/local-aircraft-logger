<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
        <style>
            html, body, #map {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100vw;
            }

            .plane-icon {
                border-radius: 50%;
                border: 1px solid white;
                padding-left: 1px;
                box-shadow: 0 0 5px 1px grey;
                text-shadow: 0 0 4px #fff;
                font-size: 19px;

                &:hover {
                    box-shadow: 0 0 5px 1px black;                    
                }
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            const LIVE_PLANE_DATA_URL = `http://${location.hostname}:8080/data.json`;
            const PAST_PLANE_DATA = 'passing-planes.log';
            const POLLING_INTERVAL = 15 * 1000; // 15s

            const queryString = new URLSearchParams(window.location.search);
            const mapViewLat = queryString.get('lat') ?? 52;
            const mapViewLon = queryString.get('lon') ?? 4;

            // reference to the map and set its default view
            const map = L.map('map').setView([mapViewLat, mapViewLon], 10);

            // these are for the live planes on the map
            const livePlaneMarkers = new Map();

            // set the tile server
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // show data of planes that have passed
            fetch(URL)
                .then(plotPlanes)
                .catch(err => console.log(err.message));

            async function plotPlanes(response) {
                if (!response.ok) {
                    throw new Error(`Response not OK: ${response.status}`);
                }

                const planeData = await response.text();
                const planeDataLines = planeData.split('\n');
                planeDataLines
                  .map(line => line.split(','))
                  .filter(planData => planeData.length >= 8)
                  .map(arr => {
                    hex: arr[1];
                    flight: arr[2];
                    time: arr[3];
                    lat: arr[4];
                    lon: arr[5];
                    distance: arr[6];
                    altitude: arr[7];
                    track: arr[8];
                    measurements: arr[9];
                  })
                  .forEach(getMarker);
            }

            function getMarker(plane) {
                const marker = L.marker([plane.lat, plane.lon], {icon: getIcon(plane.altitude, plane.track)}).addTo(map);
                marker.on('mouseover', () => marker.setZIndexOffset(100000));
                marker.on('mouseout', () => marker.setZIndexOffset(0));
                marker.bindPopup(getPopupText(plane));
                return marker;
            } 

            function getPopupText(plane) {
                return `hex: ${plane.hex}<br>flight: ${plane.flight}<br>time: ${plane.time}<br>distance: ${plane.distance} km<br>altitude: ${plane.altitude} ft<br>track: ${plane.track}<br>seen #: ${plane.measurements}`;
            }

            function getIcon(altitude, track) {
                const rotation = -45 + Number(track); // plane emoji is rotated 45 deg on most systems
                const html = `<div class="plane-icon" style="transform: rotate(${rotation}deg); background-color: ${getAltitudeColor(altitude)}">✈️</div>`;
                return L.divIcon({html, className: '', iconSize: [30, 30]});
            }

            function getAltitudeColor(altitude) {
                const maximumAltitude = 40000;
                const relativeAltitude = Math.min(Number(altitude) / maximumAltitude, 1);

                const hue = 50 + Math.floor(310 * relativeAltitude); // between yellow (50) and red (360)
                return `hsl(${hue}, 100%, 50%)`;
            }

            function plotLivePlanes(planes) {
                // get and process life plane data from dump1090
                fetch(LIVE_PLANE_DATA_URL)
                    .then(plotLiveData)
                    .catch(err => console.log(err.message));
            }

            async function plotLiveData(response) {
                if (!response.ok) {
                    throw new Error(`Response not OK: ${response.status}`);
                }

                // update live data
                const planeDataArr = await response.json();
                planeDataArr.forEach(plotPlanes);

                // remove stale data
                livePlaneMarkers.keys().forEach(hex => {
                    if (!planeDataArr.find(plane => plane.hex === hex)) {
                        livePlaneMarkers.delete(hex);
                    }
                });
            }

            const timestamp = (epoch) => new Date(epoch).toISOString();

            function plotPlanes(plane) {
                plane.distance = plane.closestDistance.toFixed(1); // will be undefined otherwise
                plane.time = timestamp(plane.closestDistanceTime);

                if (!livePlaneMarkers.has(plane.hex)) {
                    livePlaneMarkers.set(plane.hex, getMarker(plane));
                }

                const marker = livePlaneMarkers.get(plane.hex);
                marker.setLatLng([plane.lat,plane.lon]);
                marker.setTooltipContent(getPopupText(plane));
            }

            setInterval(plotLivePlanes, POLLING_INTERVAL);

        </script>
    </body>
</html>