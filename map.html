<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
        <style>
            html, body, #map {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100vw;
            }

            .plane-icon {
                border-radius: 50%;
                border: 1px solid white;
                padding-left: 1px;
                box-shadow: 0 0 5px 1px grey;
                text-shadow: 0 0 4px #fff;
                font-size: 19px;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            const URL = 'passing-planes.log';
            const queryString = new URLSearchParams(window.location.search);
            const mapViewLat = queryString.get('lat') ?? 52;
            const mapViewLon = queryString.get('lon') ?? 4;

            // reference to the map and set its default view
            var map = L.map('map').setView([mapViewLat, mapViewLon], 10);

            // set the tile server
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // show data of planes that have passed
            fetch(URL)
                .then(plotPlanes)
                .catch(err => console.log(err.message));

            async function plotPlanes(response) {
                if (!response.ok) {
                    throw new Error(`Response not OK: ${response.status}`);
                }

                const planeData = await response.text();
                const planeDataLines = planeData.split('\n');
                planeDataLines
                  .map(line => line.split(','))
                  .filter(planData => planeData.length >= 8)
                  .forEach(data => {
                    const marker = L.marker([data[4], data[5]], {icon: getIcon(data[7], data[8])}).addTo(map);
                    marker.bindPopup(getPopupText(data));
                  });
            }

            function getPopupText(data) {
                return `hex: ${data[1]}<br>flight: ${data[2]}<br>time: ${data[3]}<br>distance: ${data[6]} km<br>altitude: ${data[7]} ft<br>track: ${data[8]}<br>seen #: ${data[9]}`;
            }

            function getIcon(altitude, track) {
                const rotation = -45 + Number(track); // plane emoji is rotated 45 deg on most systems
                const html = `<div class="plane-icon" style="transform: rotate(${rotation}deg); background-color: ${getAltitudeColor(altitude)}">✈️</div>`;
                return L.divIcon({html, className: '', iconSize: [30, 30]});
            }

            function getAltitudeColor(altitude) {
                const maximumAltitude = 40000;
                const relativeAltitude = Math.min(Number(altitude) / maximumAltitude, 1);

                const hue = 50 + Math.floor(310 * relativeAltitude); // between yellow (50) and red (360)
                return `hsl(${hue}, 100%, 50%)`;
            }

        </script>
    </body>
</html>